{{#extend "title"}}Antler{{/extend}}

{{#extend "stylesheets"}}
  <link rel='stylesheet' href='/css/style.css'>
{{/extend}}

{{#extend "scripts"}}
  <script src="/js/socket.io/socket.io.js"></script>
  <script src="/js/plugins/jquery-cookie.js"></script>
{{/extend}}

{{#extend "deferred_scripts"}}
  <script>
    (function($) {
      var $h1 = $('h1');
      var $guests = $('#guests');
      var userData = null;
      var isUserActive = null;

      var sessionid = $.cookie('sessionid');
      var socket = io.connect('http://localhost:8080');
      var users = {};
      
      socket.on('user.active', function (data) {
        var title = [data.firstname, ' ', data.lastname, '.'].join('');
        userData = data;
        isUserActive = true;
        
        console.log('user.active');
        console.log(data);
        
        $h1
          .html(title)
          .addClass('active');
      });
      
      socket.on('user.inactive', function() {
        console.log('user.inactive');
        isUserActive = false;
        $h1.removeClass('active');
      });
      
      socket.on('guest.active', function(data) {
        var guestName = [data.firstname, ' ', data.lastname].join('');
        var $guest = $guests.find('[data-userid="' + data.id + '"]');
        var markup = ['<li class="guest" data-userid="', data.id, '">', guestName, '<a class="guest_connect" href="#">Connect</a></li>'].join('');
        
        // check if the guest already exists before creating them on the DOM
        if ($guest.length > 0) {
          return;
        }
        $guests.append(markup);
        
        console.log('guest.active');
        console.log(data);
      });
      
      socket.on('guest.inactive', function(data) {
        var $guest = $guests.find('[data-userid="'+ data.id +'"]');
        $guest.remove();
        
        console.log('guest.inactive');
        console.log(data);
      });
      
      socket.on('guest.disconnected', function(data){
        var $guest = $guests.find('[data-userid="'+ data.id +'"]');
        $guest.remove();
      });
      
      socket.on('guest.connect.request', function(data) {
        // TODO @paul -- fill this out 
      });
      
      socket.on('guest.connect.already', function(data) {
        // TODO @paul -- fill this out
      })
      
      $guests.delegate('.guest', 'click', function(evt) {
        var $target = $(evt.currentTarget);
        var guestId = $target.data('userid');
        
        socket.emit('connect.request', { id: guestId });
      });
      
    })(jQuery);
  </script>
{{/extend}}

<style>
h1 {
  background-color: #ccf;
  padding: 10px;
}
.guest_connect {
  margin-left: 30px;
}
</style>

<h1>Hello!</h1>
<ul id="guests"></ul>